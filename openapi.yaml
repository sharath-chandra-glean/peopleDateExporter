openapi: 3.0.3
info:
  title: People Data Exporter API
  description: |
    HTTP API for syncing user and group data from Keycloak to Glean People API.
    
    This service provides endpoints for triggering data synchronization and health monitoring.
    Designed to run on cloud platforms (GCP Cloud Run, AWS ECS Fargate) with scheduled triggers.
    
    **Key Features:**
    - Automated daily sync via Cloud Scheduler/EventBridge
    - Health check endpoint for monitoring
    - Manual sync trigger capability
    - Comprehensive error handling
    
    **Authentication:**
    - GCP Cloud Run: OIDC token-based authentication
  version: 1.0.0
  contact:
    name: People Data Exporter
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://people-data-exporter-{hash}-uc.a.run.app
    description: GCP Cloud Run (Production)
    variables:
      hash:
        default: xxxxx
        description: Auto-generated Cloud Run service hash

tags:
  - name: health
    description: Health check and monitoring endpoints
  - name: sync
    description: Data synchronization operations
  - name: info
    description: Service information

paths:
  /:
    get:
      tags:
        - info
      summary: Service Information
      description: Returns basic information about the service and available endpoints
      operationId: getServiceInfo
      responses:
        '200':
          description: Service information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInfo'
              example:
                service: people-data-exporter
                version: 1.0.0
                endpoints:
                  health: /health
                  sync: /sync (POST)

  /health:
    get:
      tags:
        - health
      summary: Health Check
      description: |
        Checks if the service is healthy and ready to accept requests.
        
        This endpoint is used by:
        - Cloud platform health checks
        - Monitoring systems
        - Load balancers
        - Cloud Scheduler pre-execution verification
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                service: people-data-exporter
                timestamp: '2025-01-23T10:30:00.000000'
        '500':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sync:
    post:
      tags:
        - sync
      summary: Trigger Data Sync
      description: |
        Triggers a synchronization of user and group data from Keycloak to Glean.
        
        **Process:**
        1. Authenticates with Keycloak
        2. Fetches all users (or limited by MAX_USERS)
        3. Fetches all groups and their members
        4. Transforms data according to field mappings
        5. Pushes formatted data to Glean People API
        
        **Execution Time:**
        - Small dataset (< 100 users): ~30 seconds
        - Medium dataset (100-1000 users): 2-5 minutes
        - Large dataset (1000+ users): 5-30 minutes
        
        **Authentication Required:**
        - OIDC token (automatically provided by Cloud Scheduler)
        
        **Note:** This endpoint may take several minutes to complete.
      operationId: triggerSync
      requestBody:
        description: Optional parameters for sync operation
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                dry_run:
                  type: boolean
                  description: If true, performs a dry run without pushing to Glean
                  default: false
                max_users:
                  type: integer
                  description: Maximum number of users to sync (for testing)
                  example: 100
      responses:
        '200':
          description: Sync completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncSuccessResponse'
              example:
                status: success
                message: Data sync completed successfully
                start_time: '2025-01-23T10:30:00.000000'
                end_time: '2025-01-23T10:35:00.000000'
                duration_seconds: 300
        '500':
          description: Sync failed
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ConfigurationErrorResponse'
                  - $ref: '#/components/schemas/SyncErrorResponse'
              examples:
                configuration_error:
                  summary: Configuration Error
                  value:
                    status: error
                    error_type: configuration_error
                    message: Missing required environment variable KEYCLOAK_CLIENT_SECRET
                    timestamp: '2025-01-23T10:30:00.000000'
                sync_error:
                  summary: Sync Error
                  value:
                    status: error
                    error_type: sync_error
                    message: Failed to authenticate with Keycloak API
                    timestamp: '2025-01-23T10:30:00.000000'

components:
  schemas:
    ServiceInfo:
      type: object
      description: Basic service information
      properties:
        service:
          type: string
          description: Service name
          example: people-data-exporter
        version:
          type: string
          description: Service version
          example: 1.0.0
        endpoints:
          type: object
          description: Available API endpoints
          properties:
            health:
              type: string
              example: /health
            sync:
              type: string
              example: /sync (POST)
      required:
        - service
        - version
        - endpoints

    HealthResponse:
      type: object
      description: Health check response
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Current health status
          example: healthy
        service:
          type: string
          description: Service name
          example: people-data-exporter
        timestamp:
          type: string
          format: date-time
          description: Timestamp of health check (ISO 8601 format)
          example: '2025-01-23T10:30:00.000000'
      required:
        - status
        - service
        - timestamp

    SyncSuccessResponse:
      type: object
      description: Successful sync operation response
      properties:
        status:
          type: string
          enum: [success]
          description: Operation status
          example: success
        message:
          type: string
          description: Success message
          example: Data sync completed successfully
        start_time:
          type: string
          format: date-time
          description: Sync start time (ISO 8601 format)
          example: '2025-01-23T10:30:00.000000'
        end_time:
          type: string
          format: date-time
          description: Sync end time (ISO 8601 format)
          example: '2025-01-23T10:35:00.000000'
        duration_seconds:
          type: number
          format: float
          description: Total sync duration in seconds
          example: 300.5
      required:
        - status
        - message
        - start_time
        - end_time
        - duration_seconds

    ConfigurationErrorResponse:
      type: object
      description: Configuration error response
      properties:
        status:
          type: string
          enum: [error]
          example: error
        error_type:
          type: string
          enum: [configuration_error]
          description: Type of error
          example: configuration_error
        message:
          type: string
          description: Detailed error message
          example: Missing required environment variable KEYCLOAK_CLIENT_SECRET
        timestamp:
          type: string
          format: date-time
          description: Error timestamp (ISO 8601 format)
          example: '2025-01-23T10:30:00.000000'
      required:
        - status
        - error_type
        - message
        - timestamp

    SyncErrorResponse:
      type: object
      description: Sync operation error response
      properties:
        status:
          type: string
          enum: [error]
          example: error
        error_type:
          type: string
          enum: [sync_error]
          description: Type of error
          example: sync_error
        message:
          type: string
          description: Detailed error message
          example: Failed to authenticate with Keycloak API
        timestamp:
          type: string
          format: date-time
          description: Error timestamp (ISO 8601 format)
          example: '2025-01-23T10:30:00.000000'
      required:
        - status
        - error_type
        - message
        - timestamp

    ErrorResponse:
      type: object
      description: Generic error response
      properties:
        status:
          type: string
          enum: [error]
          example: error
        error:
          type: string
          description: Error name/type
          example: internal_server_error
        message:
          type: string
          description: Error description
          example: An unexpected error occurred
      required:
        - status
        - error
        - message

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        OIDC token-based authentication (GCP Cloud Run)
        
        To obtain a token for testing:
        ```bash
        gcloud auth print-identity-token
        ```

security:
  - BearerAuth: []

externalDocs:
  description: Full deployment documentation
  url: https://github.com/your-repo/peopleDataExporter

